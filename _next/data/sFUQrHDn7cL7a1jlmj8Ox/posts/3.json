{"pageProps":{"postData":{"id":"3","title":"[eggjs]å¼‚å¸¸æ•è·ä¸­é—´ä»¶ï¼Œä¸€ä¸‹å­ç†è§£koaæ´‹è‘±åœˆæ¨¡å‹","tags":["eggjs"],"date":"2020-04-10","image":"/boboan.github.io/posts/3/1.png","abstract":"å¼€å§‹çœ‹ koa çš„æ—¶å€™æœ‰ä¸€ä¸ªæ´‹è‘±åœˆæ¨¡å‹çš„æ¦‚å¿µï¼Œä¸€ç›´æ²¡å¼„æ˜ç™½ã€‚ç›´åˆ°æˆ‘åœ¨è·Ÿç€ egg æ–‡æ¡£å†™å¼‚å¸¸æ•è·çš„æ—¶å€™ï¼Œçªç„¶æ˜ç™½äº†å’‹å›äº‹ã€‚","contentHtml":"<p>å¼€å§‹çœ‹koaçš„æ—¶å€™æœ‰ä¸€ä¸ªæ´‹è‘±åœˆæ¨¡å‹çš„æ¦‚å¿µï¼Œä¸€ç›´æ²¡å¼„æ˜ç™½ã€‚ç›´åˆ°æˆ‘åœ¨è·Ÿç€eggæ–‡æ¡£å†™å¼‚å¸¸æ•è·çš„æ—¶å€™ï¼Œçªç„¶æ˜ç™½äº†å’‹å›äº‹ã€‚</p>\n<p>eggçš„æ–‡æ¡£ææœ‰è¶…è¯¦ç»†çš„æ•™ç¨‹ï¼Œæ‰‹æŠŠæ‰‹å¸¦ä½ å†™ä¸€ä¸ªåå°æœåŠ¡\nè¿™é‡Œï¼š<a href=\"https://eggjs.org/zh-cn/intro/quickstart.html\">https://eggjs.org/zh-cn/intro/quickstart.html</a></p>\n<h2>ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†</h2>\n<p>åœ¨å¼€å‘æœåŠ¡æ—¶ï¼Œä¼šé‡åˆ°å¾ˆå¤šå¼‚å¸¸å’Œé”™è¯¯ï¼Œæ¯”å¦‚æ•°æ®åº“æŠ¥é”™è¿™ç§å¼‚å¸¸ï¼Œæ¯”å¦‚å¯†ç é”™è¯¯è¿™ç§ä¸šåŠ¡ç›¸å…³çš„é”™è¯¯ã€‚é‚£å½“é‡åˆ°é”™è¯¯æ—¶ï¼Œå°±ä¸éœ€è¦æ‰§è¡Œåé¢çš„é€»è¾‘ï¼Œç›´æ¥å“åº”ä¸€ä¸ªé”™è¯¯ç»™å®¢æˆ·ç«¯ã€‚</p>\n<h3>æ‹¿ç™»å½•æ¥å£ä¸¾ä¸ªä¾‹å­</h3>\n<p><img src=\"/boboan.github.io/posts/3/1.jpg\">\nâ‘ ç¬¬ä¸€æ­¥æ•°æ®åº“æ“ä½œï¼Œå¯èƒ½æˆ‘ä»¬éœ€è¦catchåˆ°é”™è¯¯ï¼Œå®Œåç»“æŸæ‰è¯·æ±‚</p>\n<pre><code class=\"language-javascript\">  try{\n    //doSomething   ...ä½ çš„æ•°æ®åº“æ“ä½œ\n  }catch(e){\n      //å•Š  å‡ºé”™äº†ï¼Œè¿›è¡Œä¸ä¸‹å»äº†\n      this.ctx.status=500\n      this.ctx.body='å†™ç‚¹å•¥'\n  }\n</code></pre>\n<p>â‘¡ç¬¬äºŒæ­¥ï¼Œæ•°æ®åº“æ˜¯å¥åº·çš„ï¼Œæˆ‘å¾—æ‹¿ç€Unameå»è¯·æ±‚Useræ•°æ®äº†</p>\n<pre><code class=\"language-javascript\">    async getUserByUname(uname){\n          const result = await model.user.getUserByUname(uname)  //æ‰§è¡Œsqlè¯­å¥\n          //æ²¡æœ‰æ•°æ®ï¼Ÿé‚£å¾—è¿”å›ï¼šæ²¡æœ‰æ­¤ç”¨æˆ·\n          if(result.length===0){\n              //æŸ¥è¯¢ä¸åˆ°ï¼Œæ›´åˆ«æå¯†ç äº†\n              this.ctx.body='æ²¡æœ‰æ­¤ç”¨æˆ·'\n          }\n          //ã€‚ã€‚ã€‚ä½ ä¹‹åçš„é€»è¾‘\n    }\n</code></pre>\n<p>â‘¢ç¬¬ä¸‰æ­¥ï¼Œæˆ‘éƒ½ä¸æƒ³å†™äº†ï¼Œå·²ç»å¾ˆä¹±äº†ï¼Œæ¯ä¸ªé”™è¯¯éƒ½è¦åœ¨controlleræ–‡ä»¶æˆ–è€…serviceæ–‡ä»¶ä¸­å“åº”ä¸€ä¸ªé”™è¯¯åŸå› messageï¼Œæ‰¾éƒ½æ‰¾ä¸åˆ°</p>\n<h3>è¯•è¯•æŠŠé”™è¯¯ç»Ÿä¸€ç®¡ç†</h3>\n<pre><code class=\"language-javascript\">//errorHandlerä¸­é—´ä»¶\nexport default () => {\n  return async function errorHandler(ctx, next) {\n    try {\n      await next()\n    } catch (err) {\n      const status = err?.status || 500\n      // ä¸çŸ¥é“æ˜¯å•¥çš„å¼‚å¸¸è®°å½•æ—¥å¿—\n      status === 500 &#x26;&#x26; ctx.app.emit('error', err, ctx);\n      const error = status === 500 &#x26;&#x26; ctx.app.config.env === 'prod'\n        ? 'Internal Server Error'\n        : err.message\n      const msg = status > 600 ? CST_ERR_CODE[status] : error\n      ctx.body = await ctx.service.response.format(status || 500, null, msg)\n    }\n  };\n};\n//è‡ªå®šä¹‰é”™è¯¯\nexport class CustError extends Error {\n  status: number\n  constructor(status: number, message?: string) {\n    super()\n    this.status = status\n    if (message) {\n      this.message = message\n    }\n  }\n}\n//é”™è¯¯ä»£ç \nexport enum CST_ERR_CODE {\n  // 10001-ç™»å½•-å¯†ç é”™è¯¯\n  Login_WrongPass = 10001,\n  // 10002-ç™»å½•-æ²¡æœ‰æ­¤ç”¨æˆ·\n  Login_NoUser = 10002,\n  // 10003-ç™»å½•-éªŒè¯å¤±è´¥\n  Login_VerificationFail = 10003,\n  // 10004-æ³¨å†Œ-é‡å¤çš„ç”¨æˆ·å\n  Regist_SameUname = 10004,\n  // 10005-æ³¨å†Œ-æ³¨å†Œå¤±è´¥\n  Regist_Wrong = 10005\n}\n</code></pre>\n<p>1.ä½¿ç”¨errorHandlerä¸­é—´ä»¶åŒ…è£¹çŒªæˆ‘ä»¬çš„ä»£ç ï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œåœ¨errorHandleré‡Œç»Ÿä¸€catché”™è¯¯ï¼Œå¹¶å“åº”é”™è¯¯\n2.è‡ªå®šä¹‰çš„é”™è¯¯å¯¹è±¡ï¼Œåœ¨åˆ¤æ–­å‡ºç™»å½•é”™è¯¯é—®é¢˜æ—¶ï¼Œç›´æ¥<code>throw new CustError(CST_ERR_CODE.Login_WrongPass)</code>\n3.å®šä¹‰é”™è¯¯ä»£ç </p>\n<h3>æ´‹è‘±åœˆæ¨¡å‹</h3>\n<p>é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå¹²ï¼Œæˆ‘æƒ³èµ·äº†æˆ‘ä»¥å‰çœ‹åˆ°çš„æ´‹è‘±åœˆæ¨¡å‹çš„å›¾ç‰‡\n<img src=\"/boboan.github.io/posts/3/2.png\">\næœ€å†…éƒ¨æ˜¯APPï¼Œå¤–é¢æ˜¯ä¸€å±‚ä¸€å±‚çš„koaä¸­é—´ä»¶ï¼Œåœ¨æ¯ä¸ªä¸­é—´ä»¶ä¸­next()æ‰§è¡Œå†…éƒ¨çš„ä»£ç \nä¸Šé¢è§£é‡Šçš„æ˜¯ErrorHandlerä¸­é—´ä»¶çš„ä½œç”¨ï¼Œå½“å†…éƒ¨æ´‹è‘±throwå‡ºé”™è¯¯æ—¶ï¼Œä½¿ç”¨ErrorHandlerä¸­é—´ä»¶catchåˆ°é”™è¯¯ç»“æŸæ‰æœ¬æ¬¡è¯·æ±‚\næ˜¯ä¸æ˜¯æ˜ç™½è¿™ä¸ªå¤§è‘±å¤´çš„å›¾ç‰‡æ˜¯å•¥æ„æ€äº†ğŸ˜€</p>\n<p>ç„¶åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ è¿™ä¸€å †functionä¸€å®šè¦ç»„æˆä¸€ä¸ªasync awaitå¼‚æ­¥é“¾ï¼Œæ‰èƒ½catchä½</p>\n"},"allTags":["nextjs","remark","typescript","taro","webpack","loader","å°ç¨‹åºæ’ä»¶","javascript","react","extention","github page","screeps","nodejs","é—²çš„","canvas","promise","vue","Parcel","eggjs","extension"]},"__N_SSG":true}